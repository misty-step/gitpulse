# yaml-language-server: $schema=https://promptfoo.dev/config-schema.json
description: "GitPulse Report Generation Evaluation"

# Prompts under test - must match production prompts in generateReport.ts
prompts:
  - id: file://prompts/daily-report.txt
    label: daily
  - id: file://prompts/weekly-report.txt
    label: weekly

# Production model only - test what we ship
providers:
  - id: openrouter:google/gemini-3-pro-preview
    config:
      temperature: 0.5  # Lower than prod for eval determinism
      max_tokens: 4000  # Match prod (generateReport.ts:291)
      maxRetries: 3

# Default assertions for all tests
defaultTest:
  options:
    maxRetries: 2  # Retry on assertion failure to reduce flakiness
    transform: |
      // Extract the LAST valid JSON block from LLM output
      // (handles thinking traces that may contain intermediate JSON)
      let text = output.trim();
      // Find all JSON-like blocks by matching balanced braces
      const matches = [];
      let depth = 0, start = -1;
      for (let i = 0; i < text.length; i++) {
        if (text[i] === '{') {
          if (depth === 0) start = i;
          depth++;
        } else if (text[i] === '}') {
          depth--;
          if (depth === 0 && start >= 0) {
            matches.push(text.slice(start, i + 1));
            start = -1;
          }
        }
      }
      // Return the last valid JSON block (final answer, not intermediate thinking)
      for (let i = matches.length - 1; i >= 0; i--) {
        try {
          JSON.parse(matches[i]);
          return matches[i];
        } catch { continue; }
      }
      return text;
  assert:
    - type: is-json
    - type: javascript
      value: |
        try {
          const p = JSON.parse(output);
          return Array.isArray(p.sections) && p.sections.length > 0 &&
                 p.sections.every(s => s.title && Array.isArray(s.bullets));
        } catch { return false; }
    - type: contains
      value: "github.com"

# Test cases
tests:
  # Daily report test with PR events
  - description: "Daily report with PR activity"
    prompts:
      - daily
    vars:
      kind: daily
      username: testuser
      dateRange: "December 10, 2025"
      eventsCount: 3
      events: |
        - **PR #42** (merged): Add user authentication [https://github.com/org/repo/pull/42]
        - **PR #43** (opened): Fix rate limiting bug [https://github.com/org/repo/pull/43]
        - **Commit** (abc1234): Update README with setup instructions [https://github.com/org/repo/commit/abc1234]
    assert:
      - type: javascript
        value: |
          const urls = ['github.com/org/repo/pull/42', 'github.com/org/repo/pull/43',
                        'github.com/org/repo/commit/abc1234'];
          return urls.every(u => output.includes(u));
      - type: llm-rubric
        value: "Report only mentions activity from the events list. No invented PRs, commits, or work."
        provider: openai:gpt-4o-mini

  # Daily report with minimal activity
  - description: "Daily report with minimal activity"
    prompts:
      - daily
    vars:
      kind: daily
      username: quietuser
      dateRange: "December 10, 2025"
      eventsCount: 1
      events: |
        - **Commit** (def5678): Minor typo fix [https://github.com/org/repo/commit/def5678]
    assert:
      - type: contains
        value: "github.com/org/repo/commit/def5678"

  # Weekly retrospective test
  - description: "Weekly retro with mixed activity"
    prompts:
      - weekly
    vars:
      kind: weekly
      username: activeuser
      dateRange: "December 2 - December 8, 2025"
      eventsCount: 5
      events: |
        - **PR #100** (merged): Implement OAuth2 flow (+500/-200, 15 files) [https://github.com/org/repo/pull/100]
        - **PR #101** (merged): Add rate limiting middleware (+150/-30, 4 files) [https://github.com/org/repo/pull/101]
        - **Issue #50** (closed): Fix memory leak in worker pool [https://github.com/org/repo/issues/50]
        - **Review PR #99**: approved - "LGTM, nice refactor" [https://github.com/org/repo/pull/99#pullrequestreview-1]
        - **Release v1.2.0**: December release with OAuth and rate limiting [https://github.com/org/repo/releases/tag/v1.2.0]
    assert:
      - type: javascript
        value: |
          const urls = ['pull/100', 'pull/101', 'issues/50', 'pull/99', 'releases/tag/v1.2.0'];
          return urls.every(u => output.includes(u));
      - type: llm-rubric
        value: "Report only mentions activity from the events list. No invented work."
        provider: openai:gpt-4o-mini

  # Citation accuracy test
  - description: "Citation extraction accuracy"
    prompts:
      - daily
    vars:
      kind: daily
      username: citationtest
      dateRange: "December 10, 2025"
      eventsCount: 3
      events: |
        - **PR #1** (merged): Feature A [https://github.com/acme/app/pull/1]
        - **PR #2** (merged): Feature B [https://github.com/acme/app/pull/2]
        - **PR #3** (merged): Feature C [https://github.com/acme/app/pull/3]
    assert:
      - type: javascript
        value: |
          const urls = ['github.com/acme/app/pull/1', 'github.com/acme/app/pull/2', 'github.com/acme/app/pull/3'];
          return urls.every(u => output.includes(u));

# Output config
outputPath: evals/.promptfoo/output/latest.json
