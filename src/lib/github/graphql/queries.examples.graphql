# GitHub GraphQL Query Examples
#
# These queries can be tested directly in the GitHub GraphQL Explorer:
# https://docs.github.com/en/graphql/overview/explorer
#
# Each query demonstrates practical usage patterns for fetching commit data
# from GitHub repositories with rate limit monitoring.

# ============================================================================
# 1. Get Repository Node IDs
# ============================================================================
# Converts repository owner/name pairs to GraphQL node IDs
# These IDs are required for batch queries

query GetRepositoryNodeIds {
  rateLimit {
    cost
    remaining
    resetAt
  }

  # Each repository needs its own alias
  react: repository(owner: "facebook", name: "react") {
    id
    nameWithOwner
    defaultBranchRef {
      name
    }
  }

  nextjs: repository(owner: "vercel", name: "next.js") {
    id
    nameWithOwner
    defaultBranchRef {
      name
    }
  }

  typescript: repository(owner: "microsoft", name: "TypeScript") {
    id
    nameWithOwner
    defaultBranchRef {
      name
    }
  }
}

# ============================================================================
# 2. Fetch Commits from Single Repository
# ============================================================================
# Basic query for fetching commit history from a single repository

query SingleRepoCommits {
  rateLimit {
    cost
    remaining
    resetAt
  }

  repository(owner: "facebook", name: "react") {
    id
    nameWithOwner
    defaultBranchRef {
      target {
        ... on Commit {
          history(
            since: "2024-01-01T00:00:00Z"
            until: "2024-01-31T23:59:59Z"
            first: 100
          ) {
            pageInfo {
              hasNextPage
              endCursor
            }
            nodes {
              oid
              committedDate
              message
              messageHeadline
              author {
                name
                email
                user {
                  login
                  id
                }
              }
            }
            totalCount
          }
        }
      }
    }
  }
}

# ============================================================================
# 3. Fetch Commits with Author Filter
# ============================================================================
# Filter commits by author email

query CommitsByAuthor {
  rateLimit {
    cost
    remaining
    resetAt
  }

  repository(owner: "vercel", name: "next.js") {
    defaultBranchRef {
      target {
        ... on Commit {
          history(
            since: "2024-01-01T00:00:00Z"
            until: "2024-01-31T23:59:59Z"
            first: 50
            author: { emails: ["author@example.com"] }
          ) {
            nodes {
              oid
              committedDate
              message
              author {
                name
                email
                user {
                  login
                }
              }
            }
          }
        }
      }
    }
  }
}

# ============================================================================
# 4. Batch Fetch Commits from Multiple Repositories
# ============================================================================
# Fetch commits from multiple repositories using their node IDs
# Note: You need to get the node IDs first using query #1

query BatchCommitHistory($nodeIds: [ID!]!) {
  rateLimit {
    cost
    remaining
    resetAt
    nodeCount
  }

  nodes(ids: $nodeIds) {
    ... on Repository {
      id
      nameWithOwner
      defaultBranchRef {
        target {
          ... on Commit {
            history(
              since: "2024-01-01T00:00:00Z"
              until: "2024-01-31T23:59:59Z"
              first: 100
            ) {
              pageInfo {
                hasNextPage
                endCursor
              }
              nodes {
                oid
                committedDate
                message
                author {
                  name
                  email
                  user {
                    login
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}

# Variables for BatchCommitHistory:
# {
#   "nodeIds": [
#     "MDEwOlJlcG9zaXRvcnkxMDI3MDI1MA==",
#     "MDEwOlJlcG9zaXRvcnk3MDEwNzc4Ng==",
#     "MDEwOlJlcG9zaXRvcnkyMDkyOTAyNQ=="
#   ]
# }

# ============================================================================
# 5. Paginated Commit History
# ============================================================================
# Fetch commits with pagination support for large histories

query PaginatedCommits($cursor: String) {
  rateLimit {
    cost
    remaining
    resetAt
  }

  repository(owner: "microsoft", name: "vscode") {
    defaultBranchRef {
      target {
        ... on Commit {
          history(
            since: "2024-01-01T00:00:00Z"
            until: "2024-01-31T23:59:59Z"
            first: 100
            after: $cursor
          ) {
            pageInfo {
              hasNextPage
              endCursor
            }
            edges {
              cursor
              node {
                oid
                committedDate
                message
                author {
                  name
                  email
                }
              }
            }
            totalCount
          }
        }
      }
    }
  }
}

# Variables for pagination:
# First page: { "cursor": null }
# Next pages: { "cursor": "Y3Vyc29yOnYyOpHOABcdefg..." }

# ============================================================================
# 6. Check Rate Limit Status
# ============================================================================
# Monitor your current rate limit status

query CheckRateLimit {
  rateLimit {
    cost
    limit
    remaining
    used
    resetAt
    nodeCount
  }

  viewer {
    login
  }
}

# ============================================================================
# 7. Validate Repository Access
# ============================================================================
# Check if you have access to a repository

query ValidateAccess {
  rateLimit {
    cost
    remaining
    resetAt
  }

  repository(owner: "facebook", name: "react") {
    id
    nameWithOwner
    isPrivate
    viewerPermission
    viewerCanAdminister
    viewerCanCreateProjects
    viewerCanSubscribe
    viewerSubscription
  }
}

# ============================================================================
# 8. Get User's Recent Commits Across Repositories
# ============================================================================
# Fetch commits by the authenticated user

query MyRecentCommits {
  rateLimit {
    cost
    remaining
    resetAt
  }

  viewer {
    login
    contributionsCollection(
      from: "2024-01-01T00:00:00Z"
      to: "2024-01-31T23:59:59Z"
    ) {
      totalCommitContributions
      commitContributionsByRepository {
        repository {
          nameWithOwner
        }
        contributions {
          totalCount
        }
      }
    }
  }
}

# ============================================================================
# 9. Repository Commit Statistics
# ============================================================================
# Get high-level commit statistics for a repository

query RepoCommitStats {
  rateLimit {
    cost
    remaining
    resetAt
  }

  repository(owner: "nodejs", name: "node") {
    nameWithOwner
    defaultBranchRef {
      name
      target {
        ... on Commit {
          history {
            totalCount
          }
          # Last 30 days of activity
          recent: history(
            since: "2024-01-01T00:00:00Z"
            until: "2024-01-31T23:59:59Z"
          ) {
            totalCount
          }
        }
      }
    }
    # Get contributor count
    mentionableUsers {
      totalCount
    }
  }
}

# ============================================================================
# 10. Complex Multi-Repository Query with Different Time Ranges
# ============================================================================
# Demonstrates fetching different data from multiple repositories

query ComplexMultiRepoQuery {
  rateLimit {
    cost
    remaining
    resetAt
  }

  # Recent activity in React
  react: repository(owner: "facebook", name: "react") {
    nameWithOwner
    defaultBranchRef {
      target {
        ... on Commit {
          lastWeek: history(
            since: "2024-01-24T00:00:00Z"
            until: "2024-01-31T23:59:59Z"
            first: 10
          ) {
            totalCount
            nodes {
              committedDate
              messageHeadline
            }
          }
        }
      }
    }
  }

  # Monthly summary for Next.js
  nextjs: repository(owner: "vercel", name: "next.js") {
    nameWithOwner
    defaultBranchRef {
      target {
        ... on Commit {
          lastMonth: history(
            since: "2024-01-01T00:00:00Z"
            until: "2024-01-31T23:59:59Z"
            first: 5
          ) {
            totalCount
          }
        }
      }
    }
  }
}

# ============================================================================
# NOTES:
# ============================================================================
#
# 1. Rate Limit Costs:
#    - Simple queries: 1 point
#    - Repository queries: 1 point per repository
#    - History queries: Cost varies by 'first' parameter
#    - Always check the 'cost' field to understand query expense
#
# 2. Node IDs:
#    - GitHub uses base64-encoded IDs for GraphQL
#    - These IDs are stable and can be cached
#    - Format: "MDEwOlJlcG9zaXRvcnkxMDI3MDI1MA=="
#
# 3. Pagination:
#    - Use 'first' parameter to limit results (max 100)
#    - Check 'hasNextPage' to determine if more data exists
#    - Use 'endCursor' as 'after' parameter for next page
#
# 4. Time Formats:
#    - Use ISO 8601 format: "2024-01-31T23:59:59Z"
#    - All times are in UTC
#
# 5. Author Filtering:
#    - Can filter by emails array: { emails: ["user@example.com"] }
#    - GitHub username filtering requires separate user lookup
#
# 6. Performance Tips:
#    - Batch multiple repository queries using aliases
#    - Use fragments for repeated field selections
#    - Request only the fields you need
#    - Monitor rate limit with every query